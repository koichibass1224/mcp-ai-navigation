# 02. アーキテクチャ設計

## MCP × Google Maps AIナビ PoC

---

## 1. 全体アーキテクチャ

### 1.1 概念図

```
┌──────────────────────────────────────────────────────┐
│                   Web Browser                         │
│  ┌─────────────────────────────────────────────────┐ │
│  │           React App (Vite + TypeScript)          │ │
│  │  ┌──────────┐ ┌──────────┐ ┌────────────────┐  │ │
│  │  │ Map View │ │Chat Input│ │  Result Panel  │  │ │
│  │  │(Leaflet) │ │          │ │(距離/時間/ログ)│  │ │
│  │  └──────────┘ └──────────┘ └────────────────┘  │ │
│  └──────────────────┬──────────────────────────────┘ │
└─────────────────────┼────────────────────────────────┘
                      │ REST API (HTTP)
                      ▼
┌──────────────────────────────────────────────────────┐
│              Backend / BFF (Express + TS)             │
│  ┌──────────────┐  ┌─────────────────────────────┐  │
│  │  API Router   │  │      MCP Client             │  │
│  │  /api/navigate│  │  (Claude API + Tool呼出)    │  │
│  └──────┬───────┘  └─────────┬───────────────────┘  │
│         │                    │                        │
│         │         ┌──────────▼───────────────────┐   │
│         │         │       MCP Server              │   │
│         │         │  ┌──────────────────────┐    │   │
│         │         │  │ route_search         │    │   │
│         │         │  │ distance_compare     │    │   │
│         │         │  │ geocode              │    │   │
│         │         │  └──────────┬───────────┘    │   │
│         │         └─────────────┼────────────────┘   │
└─────────┼───────────────────────┼────────────────────┘
          │                       │ HTTPS
          │                       ▼
          │         ┌─────────────────────────────┐
          │         │    Google Maps Platform      │
          │         │  ┌───────────┐ ┌──────────┐ │
          │         │  │Directions │ │ Distance │ │
          │         │  │   API     │ │Matrix API│ │
          │         │  └───────────┘ └──────────┘ │
          │         └─────────────────────────────┘
          │
          │         ┌─────────────────────────────┐
          └────────▶│      Claude API (Sonnet)     │
                    │  自然文解釈 → ツール選択判断   │
                    └─────────────────────────────┘
```

### 1.2 通信フロー（シーケンス）

```
User          Frontend        Backend/BFF       Claude API      MCP Server      Google Maps API
 │               │                │                │               │                │
 │  自然文入力    │                │                │               │                │
 ├──────────────▶│                │                │               │                │
 │               │  POST /api/navigate             │               │                │
 │               ├───────────────▶│                │               │                │
 │               │                │  messages[]    │               │                │
 │               │                ├───────────────▶│               │                │
 │               │                │                │               │                │
 │               │                │  tool_use:     │               │                │
 │               │                │  route_search  │               │                │
 │               │                │◀───────────────┤               │                │
 │               │                │                │               │                │
 │               │                │  execute tool  │               │                │
 │               │                ├──────────────────────────────▶│                │
 │               │                │                │               │  Directions API│
 │               │                │                │               ├───────────────▶│
 │               │                │                │               │  JSON response │
 │               │                │                │               │◀───────────────┤
 │               │                │  tool_result   │               │                │
 │               │                ├───────────────▶│               │                │
 │               │                │                │               │                │
 │               │                │  final response│               │                │
 │               │                │  (構造化JSON)  │               │                │
 │               │                │◀───────────────┤               │                │
 │               │  route data    │                │               │                │
 │               │◀───────────────┤                │               │                │
 │  地図にルート描画              │                │               │                │
 │◀──────────────┤                │                │               │                │
```

---

## 2. コンポーネント責務定義

### 2.1 Web UI（React App）

**責務**: 表示とユーザー入力の受付のみ。判断ロジックは一切持たない。

| 責務 | 詳細 |
|---|---|
| 地図表示 | Leaflet + OpenStreetMapタイルによる地図レンダリング |
| 入力受付 | 出発地・目的地のテキスト入力、自然文条件のチャット入力 |
| ルート描画 | バックエンドから受け取ったpolyline座標をLeaflet上に描画 |
| 結果表示 | 距離・所要時間・Claudeの判断理由を表示 |
| AI判断ログ | Claudeがどのツールを選び、なぜそう判断したかをリアルタイム表示 |

**持たないもの**: ルーティングロジック、API呼び出し、状態の永続化

### 2.2 Backend / BFF（Express）

**責務**: フロントエンドとAI/APIの橋渡し。Claude APIとの通信、MCPツール実行のオーケストレーション。

| 責務 | 詳細 |
|---|---|
| APIエンドポイント提供 | `/api/navigate` — ナビリクエスト受付 |
| Claude API通信 | 自然文 + システムプロンプト → Claude呼び出し |
| MCPツール実行ループ | Claudeがtool_useを返した場合、MCPサーバーのツールを実行し結果を返すループ |
| レスポンス整形 | Claudeの最終応答をフロント用JSON構造に変換 |
| APIキー管理 | Google Maps / Claude APIキーをサーバーサイドで安全に保持 |

### 2.3 MCP Server

**責務**: Google Maps APIとの通信を抽象化したツール群を提供。Claudeから「使われる」側。

| 責務 | 詳細 |
|---|---|
| ツール定義 | MCP仕様に準拠したツールスキーマの公開 |
| API呼び出し実行 | Claudeからのツール呼び出しを受けてGoogle Maps APIを実際に叩く |
| レスポンス変換 | Google Maps APIの生レスポンスをClaudeが理解しやすい構造に整形 |

**重要**: MCPサーバーは「判断」しない。Claudeの指示通りにAPIを叩いて結果を返すだけ。

### 2.4 Claude（AI）

**責務**: 唯一の「判断者」。自然文を解釈し、どのツールをどのパラメータで呼ぶかを決定する。

| 責務 | 詳細 |
|---|---|
| 自然文解釈 | ユーザーの意図・制約条件を理解 |
| ツール選択 | 条件に最適なMCPツールを自律的に選択 |
| パラメータ決定 | ツールの引数（avoid条件、alternatives有無など）を決定 |
| 結果統合 | 複数ツール呼び出し結果を統合し、最適なルートを選定 |
| 応答生成 | ルートデータ + 判断理由のテキストを構造化して返却 |

---

## 3. MCP接続方式

### 3.1 接続パターン

本PoCでは**インプロセスMCP**を採用する。Backend内にMCPサーバーをホストし、同一プロセス内で通信する。

```
Backend Process
  ├── Express Server (API)
  ├── MCP Client (Claude API通信 + tool実行)
  └── MCP Server (Google Maps APIツール群)
```

**選定理由**:
- デプロイが1プロセスで済む（Railway 1サービス）
- ネットワークレイテンシなし
- PoCとして十分、将来的にプロセス分離も可能

### 3.2 MCPプロトコル詳細

MCPサーバーは以下の標準メソッドを実装する:

- `tools/list` — 利用可能なツール一覧を返す
- `tools/call` — 指定されたツールを実行し結果を返す

Claude APIの `tool_use` / `tool_result` メッセージタイプを介して通信する。

---

## 4. 技術スタック詳細

### 4.1 フロントエンド

```
react: ^18
react-leaflet: ^4  (Leafletのreactバインディング)
leaflet: ^1.9
typescript: ^5
vite: ^5
```

### 4.2 バックエンド

```
express: ^4
@anthropic-ai/sdk: latest
@modelcontextprotocol/sdk: latest
@googlemaps/google-maps-services-js: ^3
typescript: ^5
tsx: latest (実行用)
dotenv: ^16
cors: ^2
```

### 4.3 環境変数

```
ANTHROPIC_API_KEY=sk-ant-xxx
GOOGLE_MAPS_API_KEY=AIzaxxx
PORT=3001
NODE_ENV=development
```

---

## 5. デプロイアーキテクチャ

### 5.1 構成

```
┌─────────────┐         ┌──────────────┐
│   Vercel     │  HTTPS  │   Railway    │
│  (Frontend)  │────────▶│  (Backend +  │
│  React App   │         │  MCP Server) │
└─────────────┘         └──────┬───────┘
                               │
                    ┌──────────┼──────────┐
                    ▼          ▼          ▼
              Claude API  Google Maps  (将来拡張)
```

### 5.2 デプロイ設定

| サービス | 設定 |
|---|---|
| Vercel | フロントビルド: `npm run build`、出力: `dist/` |
| Railway | バックエンド: `npm start`、ポート: `$PORT`（Railway自動割当） |

### 5.3 CORS設定

バックエンドでVercelのドメインからのリクエストのみ許可する。

---

## 6. エラーハンドリング方針

### 6.1 レイヤー別

| レイヤー | エラー種別 | 対応 |
|---|---|---|
| Frontend | ネットワークエラー | ユーザーにリトライ促すメッセージ表示 |
| Backend | Claude APIエラー | 503返却 + エラーログ |
| Backend | Google Maps APIエラー | Claudeにエラー内容を返し再判断を促す |
| MCP Server | ツール実行エラー | tool_resultにerror内容を含めてClaudeに返す |

### 6.2 タイムアウト

- フロント → バックエンド: 30秒
- バックエンド → Claude API: 25秒
- MCP Server → Google Maps API: 10秒

---

## 7. セキュリティ方針（PoC）

- APIキーは全てサーバーサイド（.env）で管理
- フロントエンドにAPIキーを露出させない
- CORS設定で許可ドメインを限定
- Rate Limitは未実装（PoC）
- 認証は未実装（PoC）
