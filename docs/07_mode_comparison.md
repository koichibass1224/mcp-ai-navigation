# 07. 通常モード vs AIモード 設計書

## MCP × Google Maps AIナビ PoC

---

## 1. 概要

### 1.1 目的

「通常のナビ」と「AIナビ」の違いを直感的に理解できるUIを提供し、MCPの価値を可視化する。

### 1.2 モード定義

| モード | 処理方式 | 自然文解釈 | ルート選択 |
|--------|----------|------------|------------|
| 通常モード | Google Maps API直接呼び出し | ❌ なし | 固定ロジック |
| AIモード | Claude + MCP経由 | ✅ あり | AIが判断 |

---

## 2. 通常モード

### 2.1 処理フロー

```
ユーザー入力
    │
    ├── 出発地: 東京駅
    ├── 目的地: 渋谷駅
    └── 条件: 「渋滞を避けて」 ← 無視される
    │
    ▼
Frontend
    │
    ▼
Backend: /api/route (通常モード)
    │
    ▼
Google Directions API
    │
    ├── origin: 東京駅
    ├── destination: 渋谷駅
    └── （その他パラメータはデフォルト）
    │
    ▼
固定ロジックでルート選択
    │
    ▼
結果返却
```

### 2.2 特徴

- **条件文は無視**: 「渋滞を避けて」等の自然文条件は処理されない
- **固定パラメータ**: API呼び出しパラメータは事前に決められたものを使用
- **高速**: AIを介さないため応答が早い
- **予測可能**: 同じ入力には常に同じ結果

### 2.3 APIエンドポイント

```
POST /api/route
Content-Type: application/json

{
  "origin": "東京駅",
  "destination": "渋谷駅"
}
```

### 2.4 レスポンス

```json
{
  "mode": "normal",
  "route": {
    "summary": "首都高速都心環状線",
    "distance": { "text": "15.2 km", "value": 15200 },
    "duration": { "text": "25分", "value": 1500 },
    "polyline": "encoded_polyline_string"
  }
}
```

---

## 3. AIモード

### 3.1 処理フロー

```
ユーザー入力
    │
    ├── 出発地: 東京駅
    ├── 目的地: 渋谷駅
    └── 条件: 「渋滞を避けて」 ← 解釈される
    │
    ▼
Frontend
    │
    ▼
Backend: /api/navigate (AIモード)
    │
    ▼
Claude API (with MCP tools)
    │
    ├── システムプロンプト
    ├── ユーザーメッセージ
    └── 利用可能ツール一覧
    │
    ▼
Claude が判断
    │
    ├── 「渋滞を避けて」→ 交通情報を考慮
    ├── departure_time=now を設定
    └── route_search ツールを選択
    │
    ▼
MCP Server: route_search 実行
    │
    ▼
Google Directions API
    │
    ├── origin: 東京駅
    ├── destination: 渋谷駅
    ├── departure_time: now     ← AIが追加
    └── traffic_model: best_guess ← AIが追加
    │
    ▼
Claude がルート選択・説明
    │
    ▼
結果返却（判断理由付き）
```

### 3.2 特徴

- **自然文解釈**: ユーザーの意図を理解してパラメータを決定
- **動的判断**: 同じ入力でも状況に応じて異なる判断
- **説明可能**: なぜそのルートを選んだか理由を提示
- **拡張可能**: MCPツールの追加で機能拡張

### 3.3 APIエンドポイント

```
POST /api/navigate
Content-Type: application/json

{
  "origin": "東京駅",
  "destination": "渋谷駅",
  "message": "渋滞を避けて"
}
```

### 3.4 レスポンス

```json
{
  "mode": "ai",
  "route": {
    "summary": "国道246号経由",
    "distance": { "text": "18.5 km", "value": 18500 },
    "duration": { "text": "30分", "value": 1800 },
    "polyline": "encoded_polyline_string"
  },
  "reasoning": "現在、首都高速都心環状線で渋滞が発生しています。一般道の国道246号経由のルートを推奨します。距離は長くなりますが、到着時間は同等です。",
  "toolCalls": [
    {
      "name": "route_search",
      "input": {
        "origin": "東京駅",
        "destination": "渋谷駅",
        "departure_time": "now",
        "alternatives": true
      }
    }
  ]
}
```

---

## 4. 比較表示UI

### 4.1 レイアウト

```
┌─────────────────────────────────────────────────────────┐
│  ┌───────────────┐  ┌───────────────┐                   │
│  │ 通常モード    │  │ AIモード ✦    │  ← セグメント    │
│  └───────────────┘  └───────────────┘                   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  出発地   [東京駅                              ]        │
│                                                         │
│  目的地   [渋谷駅                              ]        │
│                                                         │
│  条件     [渋滞を避けて                        ]        │
│           └─ 通常モードでは無視されます（グレー表示）   │
│                                                         │
│  [        ルート検索        ]                           │
│                                                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  【通常モード結果】              ← 通常モード時のみ     │
│  ● 首都高速経由                                        │
│    15.2 km / 約25分                                    │
│                                                         │
│  【AI推奨ルート】               ← AIモード時のみ        │
│  ✦ 国道246号経由                                       │
│    18.5 km / 約30分                                    │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 🤖 AI判断ログ                                   │   │
│  │                                                 │   │
│  │ 1. 「渋滞を避けて」を検出                       │   │
│  │ 2. departure_time=now を設定                   │   │
│  │ 3. route_search ツールを実行                   │   │
│  │ 4. 3つのルート候補から交通状況を比較           │   │
│  │ 5. 国道246号経由を推奨                         │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 4.2 地図表示

- **通常モード**: シアン色のルート線 (`#64d2ff`)
- **AIモード**: パープル色のルート線 (`#bf5af2`)
- 両モードの結果を同時表示する場合は色分けで区別

### 4.3 モード切り替え時の挙動

| 切り替え | 動作 |
|----------|------|
| 通常 → AI | 条件入力欄がアクティブ化、前回検索結果をクリア |
| AI → 通常 | 条件入力欄がグレーアウト、前回検索結果をクリア |

---

## 5. 自然文条件の解釈例

### 5.1 通常モードの場合

| ユーザー入力 | 処理結果 |
|--------------|----------|
| 「渋滞を避けて」 | **無視** → デフォルトルート |
| 「高速使わないで」 | **無視** → デフォルトルート |
| 「一番早いルートで」 | **無視** → デフォルトルート |

### 5.2 AIモードの場合

| ユーザー入力 | Claudeの解釈 | API呼び出し |
|--------------|--------------|-------------|
| 「渋滞を避けて」 | 交通情報を考慮 | `departure_time=now` |
| 「高速使わないで」 | 高速道路回避 | `avoid=["highways"]` |
| 「一番早いルートで」 | 複数候補から最短選択 | `alternatives=true` + 比較 |
| 「右折少なめで」 | マニューバ解析 | `alternatives=true` + steps解析 |

---

## 6. 実装チェックリスト

### Phase 1: 通常モード

- [ ] `/api/route` エンドポイント実装
- [ ] モード切り替えUIコンポーネント
- [ ] 条件入力欄のグレーアウト制御
- [ ] 通常モード結果表示

### Phase 2: AIモード（既存）

- [x] `/api/navigate` エンドポイント（実装済み）
- [ ] AI判断ログ表示コンポーネント
- [ ] ツール呼び出し詳細表示
- [ ] 推奨理由の表示

### Phase 3: 比較表示

- [ ] 両モードの結果を並列表示
- [ ] 地図上でルートを色分け表示
- [ ] 差分ハイライト（距離・時間の違い）

---

## 7. 技術的考慮事項

### 7.1 レスポンス時間

| モード | 想定時間 | 内訳 |
|--------|----------|------|
| 通常 | 0.5〜1秒 | Google API呼び出しのみ |
| AI | 3〜8秒 | Claude API + Google API |

### 7.2 エラーハンドリング

- 通常モード: Google APIエラーをそのまま表示
- AIモード: Claude APIエラー時は通常モードにフォールバック

### 7.3 APIキー不在時

- 通常モード: Google APIキーがあれば動作
- AIモード: Anthropic APIキーがない場合「Coming Soon」表示

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2024-XX-XX | 初版作成 |
